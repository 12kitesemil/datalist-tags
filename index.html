<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>selection-mockup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>

  </head>
  <body>

    <div class="container">
        <div class="row my-1">
            <div id="tags" class="col" style="">

                        <form id="form">
                            <label for="selectedAudiences" class="form-label">Audiences</label>
                            <select style="visibility: hidden; display: none;" multiple="" name="selectedAudiences" id="selectedAudiences">
                                <option value="pblc">Public</option>
                                <option value="usr">User</option>
                                <option value="stf">Staff</option>
                                <option selected value="mgr">Manager</option>
                                <option value="ar1">Area 1</option>
                                <option value="ar2">Area 2</option>
                                <option value="ar3">Area 3</option>
                                <option value="ar4">Area 4</option>
                            </select>
                        </form> 
                        <div class="row">
                            <label for="tags-container" class="form-label">Audience</label>
                                <div class="input-group mb-3">
                                <div class="tags-container-outer form-control d-flex flex-wrap align-items-center gx-5">
                                    <span class="no-tags-msg text-muted">None selected</span>
                                    <div id="tags-container" class="flex-shrink-1 me-2"> </div>
                                    <input oninput="onAudienceInput()" type="text" class="form-control border-none audience-selector my-2" list="audience-list" id="audience-input" placeholder="Start typing to add..." style="display: none;">

                                </div>
                                <button type="button" class="btn btn-outline-success add-audience-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                      </svg>
                                </button>
                            </div>
                            <datalist id="audience-list"></datalist>
                        </div>                       
                    </div>

        </div>
    </div>

    <script>

        let processedOptions = [];

        let tagsContainer = $('#tags-container')
        let datalist = $('#audience-list')


        const enableAddAudienceButton = () => {
            $('.add-audience-btn').removeClass('disabled').removeAttr('disabled');
        }
        const disableAddAudienceButton = () => {
            $('.add-audience-btn').addClass('disabled').attr('disabled', 'disabled');
        }
        const showAudienceInput = (andFocus) => {
            $('#audience-input').show();
            if (andFocus) {
                $('#audience-input').focus();
            }
        }
        const hideAudienceInput = () => {
            $('#audience-input').hide();
        }

        let getKeyByValue = function(object, value) {
            return Object.keys(object).find(key => object[key] === value);
        }

        let getOptionByValue = function(value) {
            
            let a = processedOptions.filter(option => { return option.value === value});
            if (a.length > 0) {
                return a[0];
            } 
        }

        let appendOptionToDatalist = function(option) {
            let html = optionToDataListElement(option)
            datalist.prepend(html)
        }

        const onAudienceChange = () => {
            if( tagsContainer.children().length === 0 ) {
                enableAddAudienceButton();
                hideAudienceInput();
                $('.no-tags-msg').show()
            } else {
                $('.no-tags-msg').hide()
            }
            regenerateDataListFromSelectElement()
        }

        //the click handler is on the cross element rather than the entire tag, so we look at the parent for the 
        //value and also remove the parent. 
        let tagClickHandler = function() {

            let selectedValue = $(this)
            //add value back to the selection pool
            let value = selectedValue.parent().attr('data-item-value');
            let option = getOptionByValue(value);
            removeOptionFromFormSelectControl(option);

            $(this).parent().remove()
            onAudienceChange();
        }

        let addOptionToFormSelectControl = (option) => {
            $(`#selectedAudiences option[value="${option.value}"]`).attr('selected', 'selected')
        }
        let removeOptionFromFormSelectControl = (option) => {
            $(`#selectedAudiences option[value="${option.value}"]`).removeAttr('selected')
        }

        let onAudienceInput = function(e) {

            let input = $('#audience-input')
            let options = document.querySelector('#audience-list').childNodes

            let selectedOption = false;
            let changeHappened = false;

            for (let i = 0; i < options.length; i++) {
                let option = options[i]
                let humanFriendlyValue = options[i].value

                if (humanFriendlyValue === input.val()) {
                    selectedOption = option;
                    
                    break;
                }
            }
            if (selectedOption) {
                let dv = $(selectedOption).attr('data-value');
                if (dv) {
                    let option = getOptionByValue(dv)
                    if (option) {
                        createTagElement(option)
                        $(selectedOption).remove()
                    }
                }
  
                input.val('')

                changeHappened = true;
            }
            if (changeHappened) {
                onAudienceChange();
                hideAudienceInput();
                enableAddAudienceButton();
            }
        }

        function createTagElement( option ) {
            tagsContainer.append(function() {
                    let outer = $(`<span class="tag-item badge rounded-pill text-bg-primary me-1 ps-3" data-item-value="${option.value}"><span class="tag-label">${option.label}</span></span>`);
                    let cross = $(`
                        <span class="cross-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x ms-1" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                        </span>
                    `)
                    cross.click(tagClickHandler)
                    return outer.append(cross)
                })

                $('.no-tags-msg').hide()
                addOptionToFormSelectControl(option)
        }

        function regenerateDataListFromSelectElement() {
            let s = _processSelect().filter(option => { return !option.selected });
            let html = s.map(optionToDataListElement).join("\n");
            datalist.html(html)
        }

        $('.add-audience-btn').click(function() {
            showAudienceInput(true);
            disableAddAudienceButton();
        })
        const _processSelect = () => {
            let options = $('#selectedAudiences option');
            let res = [];
            for (let i = 0; i < options.length; i++) {
                let option = options[i];
                let value = option.value;
                let label = option.innerHTML;
                let selected = false;
                let selectedAttr = option.getAttribute('selected')
                if (typeof selectedAttr !== 'undefined' && selectedAttr !== false && selectedAttr !== null) {
                    selected = true;
                }
                res.push({
                    value: value,
                    label: label,
                    order: i,
                    selected: selected
                })
            }
            return res;
        }

        const processOptionsFromSelect = () => {
            processedOptions = _processSelect();
        }

        const optionToDataListElement = (option, selected) => {
            let res = `<option class="list-option" data-value="${option.value}">${option.label}</option>`
            return res;
        }

        const initDataList = () => {
            processedOptions.forEach(element => {
                if (!element.selected) {
                    let html = optionToDataListElement(element)
                    datalist.append(html)
                } else {
                    createTagElement(element)
                }
            });
        }

        const initLayout = () => {
            if(tagsContainer.children().length) {
                $('.no-tags-msg').hide()
            } else {
                $('.no-tags-msg').show()
            }
        }

        const init = () => {
            processOptionsFromSelect();
            initDataList();
            onAudienceChange();
        }
        
        init();







    </script>

    <style>
        #tags-container {
            display: flex;
        }

        #tags-container {
            /* margin-bottom: 1rem; */
            width: auto;
            justify-content: space-evenly;
            align-items: center;
        }

        .card-body .row {
            align-items: baseline;
        }



        span.tag-item {
            /* background-color: #dae9f7;
            padding: 0.5rem;
            border-radius: 4px;
            margin-right: 0.2rem; */
            font-size: 16px;
        }

        .add-audience-btn {
            
            /* order: 99;
            width: auto;
            padding: 0;
            height: 25px;
            background-color: transparent;
            border: none; */
        }
        .add-audience-btn svg {
            top: -2px;
            position: relative;
        }
        .tags-container-outer {
            /* border: 1px solid #cccccc; */
        }
        .cross-button {
            cursor: pointer;
        }
        .audience-selector {
            min-width: 150px;
            width:100%;
            max-width: 350px;
        }
        


    </style>


  </body>

</html>
